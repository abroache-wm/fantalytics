<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Fantasy Football Draft Analytics</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin:0; padding:0; box-sizing:border-box; }
        :root{
            --bg-primary:#0a0e1a; --bg-secondary:#151923; --bg-accent:#1e2433;
            --text-primary:#fff; --text-secondary:#a0a9c4;
            --accent-blue:#4a9eff; --accent-green:#4ade80; --accent-red:#ef4444;
            --accent-yellow:#fbbf24; --accent-purple:#a78bfa; --accent-orange:#fb923c;
        }
        body{ font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif; background:var(--bg-primary); color:var(--text-primary); line-height:1.6; }
        .container{ max-width:1600px; margin:0 auto; padding:20px; }
        header{ text-align:center; margin-bottom:40px; padding:40px 0; background:linear-gradient(135deg,var(--bg-secondary),var(--bg-accent)); border-radius:20px; position:relative; }
        .back-link{ position:absolute; left:20px; top:20px; color:var(--accent-blue); text-decoration:none; font-weight:600; transition:.3s }
        .back-link:hover{ color:var(--accent-purple); transform:translateX(-5px); }
        h1{ font-size:3em; margin-bottom:10px; background:linear-gradient(135deg,var(--accent-orange),var(--accent-yellow));
            -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
        .subtitle{ color:var(--text-secondary); font-size:1.2em; }
        .nav-tabs{ display:flex; gap:10px; margin:30px 0; flex-wrap:wrap; justify-content:center; }
        .nav-tab{ background:var(--bg-secondary); border:2px solid transparent; padding:12px 24px; border-radius:10px; cursor:pointer; transition:.3s; font-weight:600; }
        .nav-tab:hover{ background:var(--bg-accent); border-color:var(--accent-orange); }
        .nav-tab.active{ background:var(--accent-orange); color:var(--bg-primary); }
        .tab-content{ display:none; }
        .tab-content.active{ display:block; }
        .stats-grid{ display:grid; grid-template-columns:repeat(auto-fit,minmax(300px,1fr)); gap:20px; margin-bottom:40px; }
        .stat-card{ background:var(--bg-secondary); border-radius:15px; padding:25px; box-shadow:0 10px 30px rgba(0,0,0,.3); transition:.3s }
        .stat-card:hover{ transform:translateY(-5px); }
        .stat-label{ color:var(--text-secondary); font-size:.9em; margin-bottom:5px; }
        .stat-value{ font-size:2.3em; font-weight:700; color:var(--accent-orange); }
        .stat-trend{ font-size:.9em; margin-top:5px; color:var(--text-secondary); }
        .trend-up{ color:var(--accent-green); } .trend-down{ color:var(--accent-red); }
        .chart-container{ background:var(--bg-secondary); border-radius:15px; padding:25px; margin-bottom:30px; height:400px; position:relative; }
        .table-container{ background:var(--bg-secondary); border-radius:15px; padding:25px; overflow-x:auto; margin-bottom:30px; }
        table{ width:100%; border-collapse:collapse; }
        th,td{ padding:12px; text-align:left; border-bottom:1px solid var(--bg-accent); }
        th{ background:var(--bg-accent); font-weight:600; position:sticky; top:0; z-index:10; }
        tr:hover{ background:var(--bg-accent); }
        .sortable th{ cursor:pointer; user-select:none; position:relative; padding-right:25px; }
        .sortable th:hover{ background:var(--accent-orange); color:var(--bg-primary); }
        .sortable th:after{ content:'↕'; position:absolute; right:8px; opacity:.5; }
        .sortable th.sort-asc:after{ content:'↑'; opacity:1; } .sortable th.sort-desc:after{ content:'↓'; opacity:1; }
        .filter-controls{ background:var(--bg-secondary); border-radius:15px; padding:20px; margin-bottom:30px; display:flex; gap:20px; flex-wrap:wrap; align-items:center; }
        select{ background:var(--bg-accent); color:var(--text-primary); border:1px solid var(--accent-orange); padding:8px 16px; border-radius:8px; cursor:pointer; }
        .loader{ text-align:center; padding:50px; }
        .error{ background:rgba(239,68,68,.1); border:1px solid var(--accent-red); color:var(--accent-red); padding:20px; border-radius:10px; margin:20px 0; }
        .heat-map{ margin-top:20px; }
        .heat-map-grid{ display:grid; gap:2px; margin-top:10px; }
        .heat-cell{ padding:10px; text-align:center; font-size:.9em; min-height:40px; display:flex; align-items:center; justify-content:center; border-radius:5px; }
        .heat-cell-header{ background:var(--bg-accent); font-weight:600; }
        .best-worst-picks{ display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-top:20px; }
        .picks-list{ background:var(--bg-accent); border-radius:10px; padding:20px; }
        .picks-list h4{ margin-bottom:15px; color:var(--accent-orange); }
        .pick-item{ padding:8px 0; border-bottom:1px solid var(--bg-secondary); }
        .pick-item:last-child{ border-bottom:none; }
        .grade-badge{ display:inline-block; padding:4px 12px; border-radius:20px; font-weight:600; font-size:.9em; }
        .grade-a{ background:rgba(74,222,128,.2); color:var(--accent-green); }
        .grade-b{ background:rgba(74,158,255,.2); color:var(--accent-blue); }
        .grade-c{ background:rgba(251,191,36,.2); color:var(--accent-yellow); }
        .grade-d{ background:rgba(251,146,60,.2); color:var(--accent-orange); }
        .grade-f{ background:rgba(239,68,68,.2); color:var(--accent-red); }
        /* Archetype chips */
        .chip{ display:inline-block; padding:4px 10px; border-radius:999px; font-weight:700; font-size:.8rem; margin:0 6px 6px 0; }
        .chip-rb{ background:rgba(74,222,128,.2); color:var(--accent-green); }
        .chip-wr{ background:rgba(74,158,255,.2); color:var(--accent-blue); }
        .chip-te{ background:rgba(167,139,250,.2); color:var(--accent-purple); }
        .chip-qb{ background:rgba(251,191,36,.2); color:var(--accent-yellow); }
        .chip-mixed{ background:rgba(251,146,60,.2); color:var(--accent-orange); }
        .note{ color:var(--text-secondary); font-size:.9em; margin:8px 0 16px; }
    </style>
</head>
<body>
<div class="container">
    <header>
        <a href="index.html" class="back-link">← Back to Main Dashboard</a>
        <h1>Draft Analytics Dashboard</h1>
        <p class="subtitle">Comprehensive Draft Performance Analysis</p>
    </header>

    <div id="loadingMessage" class="loader">Loading draft data...</div>

    <div id="mainContent" style="display:none;">
        <div class="nav-tabs">
            <div class="nav-tab active" data-tab="overview">Overview</div>
            <div class="nav-tab" data-tab="value">Draft Value</div>
            <div class="nav-tab" data-tab="positions">Positions</div>
            <div class="nav-tab" data-tab="rounds">Rounds</div>
            <div class="nav-tab" data-tab="trends">Trends</div>
            <div class="nav-tab" data-tab="owners">Owners</div>
            <div class="nav-tab" data-tab="archetypes">Drafter Archetypes</div>
        </div>

        <!-- OVERVIEW -->
        <div class="tab-content active" id="overview">
            <div class="stats-grid" id="overviewStats"></div>
            <div class="chart-container"><canvas id="draftPerformanceChart"></canvas></div>
            <div class="table-container">
                <h2>Recent Draft Summary</h2>
                <table id="recentDraftTable" class="sortable"></table>
            </div>
        </div>

        <!-- VALUE -->
        <div class="tab-content" id="value">
            <div class="filter-controls">
                <label>Year:
                    <select id="valueYearSelect">
                        <option value="all">All Years</option>
                    </select>
                </label>
                <label>Position:
                    <select id="valuePositionSelect">
                        <option value="all">All Positions</option>
                        <option value="QB">QB</option>
                        <option value="RB">RB</option>
                        <option value="WR">WR</option>
                        <option value="TE">TE</option>
                        <option value="D/ST">D/ST</option>
                        <option value="K">K</option>
                    </select>
                </label>
            </div>
            <div class="best-worst-picks">
                <div class="picks-list">
                    <h4>Best Draft Values</h4>
                    <div id="bestValues"></div>
                </div>
                <div class="picks-list">
                    <h4>Biggest Draft Busts</h4>
                    <div id="worstValues"></div>
                </div>
            </div>
            <div class="chart-container" style="margin-top:30px;"><canvas id="valueChart"></canvas></div>
        </div>

        <!-- POSITIONS -->
        <div class="tab-content" id="positions">
            <div class="heat-map">
                <h2>Position Success by Round</h2>
                <p class="subtitle">Average value above/below expected by position and round</p>
                <div id="positionHeatMap"></div>
            </div>
            <div class="chart-container" style="margin-top:30px;"><canvas id="positionTimingChart"></canvas></div>
        </div>

        <!-- ROUNDS -->
        <div class="tab-content" id="rounds">
            <div class="chart-container"><canvas id="roundValueChart"></canvas></div>
            <div class="table-container">
                <h2>Best Picks by Round</h2>
                <table id="roundTable" class="sortable"></table>
            </div>
        </div>

        <!-- TRENDS -->
        <div class="tab-content" id="trends">
            <div class="chart-container"><canvas id="trendsChart"></canvas></div>
            <div class="table-container">
                <h2>Year-over-Year Draft Performance</h2>
                <table id="yearlyTable" class="sortable"></table>
            </div>
        </div>

        <!-- OWNERS -->
        <div class="tab-content" id="owners">
            <div class="filter-controls">
                <label>Select Owner:
                    <select id="ownerSelect"><option value="">All Owners</option></select>
                </label>
            </div>
            <div class="stats-grid" id="ownerStats"></div>
            <div class="chart-container"><canvas id="ownerChart"></canvas></div>
            <div class="table-container">
                <h2>Owner Draft History</h2>
                <table id="ownerTable" class="sortable"></table>
            </div>
        </div>

        <!-- ARCHETYPES -->
        <div class="tab-content" id="archetypes">
            <div class="filter-controls">
                <div>
                    <strong>Archetype Definition:</strong>
                    <div class="note">
                        Based on a drafter’s <em>first two selections</em> each year. <br/>
                        RB-RB, WR-WR, RB-WR, WR-RB, TE-Early (TE in first two), QB-Early (QB in first two), Mixed (anything else).
                    </div>
                </div>
                <label>Owner:
                    <select id="archOwnerSelect"><option value="">All Owners</option></select>
                </label>
                <label>Year:
                    <select id="archYearSelect"><option value="all">All Years</option></select>
                </label>
            </div>

            <div class="stats-grid" id="archetypeTopStats"></div>

            <div class="chart-container"><canvas id="archetypeBarChart"></canvas></div>

            <div class="table-container">
                <h2>Archetype Outcomes (Owner-Year Cohorts)</h2>
                <p class="note">A cohort = one owner’s draft in a given year. Metrics summarize the <em>entire draft</em> performance for that cohort.</p>
                <table id="archetypeTable" class="sortable"></table>
            </div>

            <div class="table-container">
                <h2>Round-1 & Round-2 Position Splits</h2>
                <p class="note">Distribution of your first two picks by position across years/owners.</p>
                <table id="firstTwoTable" class="sortable"></table>
            </div>
        </div>
    </div>
</div>

<script>
/* ===========================
   ROBUST UTILITIES
   =========================== */
const Charts = new Map(); // canvasId -> Chart
const isNum = v => typeof v === 'number' && Number.isFinite(v);
const toNum = v => {
  const n = typeof v === 'string' ? parseFloat(v) : v;
  return Number.isFinite(n) ? n : 0;
};
const safeAvg = arr => arr.length ? arr.reduce((s,v)=>s+toNum(v),0)/arr.length : 0;
const safePct = (num, den) => den > 0 ? (toNum(num)/toNum(den))*100 : 0;
const nonEmpty = a => Array.isArray(a) && a.length > 0;
const defined = v => v !== undefined && v !== null;
const getRecentYear = obj => {
  const ks = Object.keys(obj||{}).map(Number).filter(Number.isFinite);
  return ks.length ? Math.max(...ks) : null;
};
function upsertChart(canvasId, config){
  const canvas = document.getElementById(canvasId);
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  const existing = Charts.get(canvasId);
  if (existing) existing.destroy();
  const chart = new Chart(ctx, config);
  Charts.set(canvasId, chart);
  return chart;
}
function setInnerHTML(id, html){ const el = document.getElementById(id); if (el) el.innerHTML = html; }
function setText(id, text){ const el = document.getElementById(id); if (el) el.textContent = text; }
function emptyState(message){ return `<div class="error" role="alert">${message}</div>`; }

/* ===========================
   GLOBAL STATE
   =========================== */
let draftData = null;
let leagueData = null;
const processedData = {
  picks: [],
  byYear: {},
  byOwner: {},
  byPosition: {},
  byRound: {},
  ownerYear: {},
  archetypes: { cohorts: [], byType: {} }
};

/* ===========================
   LOADING (robust)
   =========================== */
async function safeFetchJSON(path, required=true){
  try {
    const res = await fetch(path, { cache: 'no-store' });
    if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);
    return await res.json();
  } catch (e){
    if (required) throw new Error(`Failed to load ${path}: ${e.message}`);
    console.warn(`Optional file missing: ${path}`, e);
    return null;
  }
}

window.addEventListener('DOMContentLoaded', async () => {
  try {
    draftData = await safeFetchJSON('espn_fantasy_draft_data.json', true);
    leagueData = await safeFetchJSON('espn_fantasy_complete_data.json', false);

    // Minimal schema checks
    if (typeof draftData !== 'object' || draftData === null) {
      throw new Error('Draft data is not a valid JSON object.');
    }

    processDraftData();
    buildOwnerYearIndex();
    buildArchetypes();

    setText('loadingMessage', '');
    document.getElementById('loadingMessage').style.display = 'none';
    document.getElementById('mainContent').style.display = 'block';
    initializeDashboard();
  } catch (err) {
    setInnerHTML('loadingMessage', emptyState(`Error loading data: ${err.message}
      <br>Make sure <code>espn_fantasy_draft_data.json</code> is in the same folder.`));
    console.error(err);
  }
});

/* ===========================
   PROCESSING (robust)
   =========================== */
function expectedFromRound(round){
  const r = toNum(round);
  return (17 - (r || 17)) * 15;
}
function expectedFromOverall(overall){
  const o = toNum(overall);
  return (193 - (o || 192)) * 1.5;
}

function processDraftData(){
  processedData.picks = [];
  processedData.byYear = {};
  processedData.byOwner = {};
  processedData.byPosition = {};
  processedData.byRound = {};

  Object.entries(draftData || {}).forEach(([year, yData])=>{
    const yearNum = Number(year);
    const picks = (yData && Array.isArray(yData.picks)) ? yData.picks : [];
    picks.forEach(pick=>{
      const owner = pick.owner_name || pick.team_name || 'Unknown';
      const position = pick.position || 'Unknown';
      const expectedValue = defined(pick.round) ? expectedFromRound(pick.round) : expectedFromOverall(pick.overall_pick);
      const actualValue = toNum(pick.season_points);

      const processedPick = {
        ...pick,
        owner,
        position,
        year: yearNum,
        expectedValue,
        actualValue,
        valueOverExpected: actualValue - expectedValue,
        round: defined(pick.round) ? toNum(pick.round) : undefined,
        overall_pick: defined(pick.overall_pick) ? toNum(pick.overall_pick) : undefined,
        pick_number: defined(pick.pick_number) ? toNum(pick.pick_number) : undefined
      };

      processedData.picks.push(processedPick);
      (processedData.byYear[yearNum] ||= []).push(processedPick);
      (processedData.byOwner[owner] ||= []).push(processedPick);
      (processedData.byPosition[position] ||= []).push(processedPick);
      if (defined(processedPick.round)) (processedData.byRound[processedPick.round] ||= []).push(processedPick);
    });
  });
}

function buildOwnerYearIndex(){
  processedData.ownerYear = {};
  processedData.picks.forEach(p=>{
    const key = `${p.owner}::${p.year}`;
    (processedData.ownerYear[key] ||= []).push(p);
  });

  Object.values(processedData.ownerYear).forEach(arr=>{
    arr.sort((a,b)=>{
      const ao = defined(a.overall_pick) ? a.overall_pick : (toNum(a.round)*100 + toNum(a.pick_number));
      const bo = defined(b.overall_pick) ? b.overall_pick : (toNum(b.round)*100 + toNum(b.pick_number));
      return ao - bo;
    });
  });
}

/* ===========================
   ARCHETYPES (robust)
   =========================== */
function firstTwoToArchetype(firstTwo){
  const pos = firstTwo.map(p=>p?.position || 'Unknown');
  const hasQB = pos.includes('QB');
  const hasTE = pos.includes('TE');
  if (hasTE) return 'TE-Early';
  if (hasQB) return 'QB-Early';
  if (pos[0]==='RB' && pos[1]==='RB') return 'RB-RB';
  if (pos[0]==='WR' && pos[1]==='WR') return 'WR-WR';
  if (pos[0]==='RB' && pos[1]==='WR') return 'RB-WR';
  if (pos[0]==='WR' && pos[1]==='RB') return 'WR-RB';
  return 'Mixed';
}
function summarizeCohort(picks){
  const totalPicks = picks.length;
  const sumActual = picks.reduce((s,p)=>s+toNum(p.actualValue),0);
  const sumOver = picks.reduce((s,p)=>s+toNum(p.valueOverExpected),0);
  const hits = picks.filter(p=>toNum(p.valueOverExpected)>10).length;
  const busts = picks.filter(p=>toNum(p.valueOverExpected)<-20).length;
  const bestPick = picks.reduce((best,p)=> toNum(p.valueOverExpected) > toNum(best?.valueOverExpected ?? -Infinity) ? p : best, null);
  return {
    totalPicks,
    avgPoints: totalPicks ? (sumActual/totalPicks) : 0,
    avgVOE: totalPicks ? (sumOver/totalPicks) : 0,
    hitRate: safePct(hits, totalPicks),
    bustRate: safePct(busts, totalPicks),
    bestPick
  };
}
function buildArchetypes(){
  const cohorts = [];
  Object.entries(processedData.ownerYear).forEach(([key, picks])=>{
    const [owner, yearStr] = key.split('::');
    const year = Number(yearStr);
    const firstTwo = picks.slice(0,2);
    if (!nonEmpty(firstTwo)) return;
    const archetype = firstTwoToArchetype(firstTwo);
    const summary = summarizeCohort(picks);
    cohorts.push({
      owner, year, archetype,
      first: firstTwo[0]?.position || '—',
      second: firstTwo[1]?.position || '—',
      ...summary
    });
  });
  const byType = {};
  cohorts.forEach(c => (byType[c.archetype] ||= []).push(c));
  processedData.archetypes.cohorts = cohorts;
  processedData.archetypes.byType = byType;
}

/* ===========================
   UI INIT
   =========================== */
function initializeDashboard(){
  document.querySelectorAll('.nav-tab').forEach(tab=>{
    tab.addEventListener('click', function(){
      document.querySelectorAll('.nav-tab').forEach(t=>t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
      this.classList.add('active'); document.getElementById(this.dataset.tab).classList.add('active');

      switch(this.dataset.tab){
        case 'overview': loadOverview(); break;
        case 'value': loadValueAnalysis(); break;
        case 'positions': loadPositionAnalysis(); break;
        case 'rounds': loadRoundAnalysis(); break;
        case 'trends': loadTrends(); break;
        case 'owners': loadOwnerAnalysis(); break;
        case 'archetypes': loadArchetypes(); break;
      }
    });
  });
  loadOverview();
}

/* ===========================
   OVERVIEW
   =========================== */
function loadOverview(){
  if (!nonEmpty(processedData.picks)){
    setInnerHTML('overviewStats', emptyState('No picks found in the dataset.'));
    setInnerHTML('recentDraftTable', '');
    upsertChart('draftPerformanceChart', { type:'bar', data:{labels:[],datasets:[]}, options:{} });
    return;
  }

  const totalPicks = processedData.picks.length;
  const years = Object.keys(processedData.byYear).map(Number);
  const mostRecent = getRecentYear(processedData.byYear);
  const avgPoints = safeAvg(processedData.picks.map(p=>p.actualValue));
  const bestPick = processedData.picks.reduce((best,p)=> toNum(p.valueOverExpected) > toNum(best?.valueOverExpected ?? -Infinity) ? p : best, null);

  setInnerHTML('overviewStats', `
    <div class="stat-card">
      <div class="stat-label">Total Draft Picks</div>
      <div class="stat-value">${totalPicks.toLocaleString()}</div>
      <div class="stat-trend">${years.length} seasons analyzed</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Average Points Per Pick</div>
      <div class="stat-value">${avgPoints.toFixed(1)}</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Best Value Pick Ever</div>
      <div class="stat-value" style="font-size:1.5em;">${bestPick?.player_name ?? '—'}</div>
      <div class="stat-trend">Round ${defined(bestPick?.round)?bestPick.round:'—'} → ${toNum(bestPick?.actualValue).toFixed(0)} pts</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Most Recent Draft</div>
      <div class="stat-value">${mostRecent ?? '—'}</div>
      <div class="stat-trend">${mostRecent ? (processedData.byYear[mostRecent]?.length ?? 0) : 0} picks</div>
    </div>
  `);

  createDraftPerformanceChart();
  createRecentDraftTable();
}

function createDraftPerformanceChart(){
  const ownerPerformance = {};
  Object.entries(processedData.byOwner).forEach(([owner, picks])=>{
    ownerPerformance[owner] = safeAvg(picks.map(p=>p.valueOverExpected));
  });
  const top = Object.entries(ownerPerformance).sort((a,b)=>b[1]-a[1]).slice(0,12);

  upsertChart('draftPerformanceChart', {
    type:'bar',
    data:{
      labels: top.map(([o])=>o),
      datasets:[{
        label: 'Avg Value Over Expected',
        data: top.map(([,v])=>v),
        backgroundColor: top.map(([,v])=> v>0?'rgba(74,222,128,.6)':'rgba(239,68,68,.6)'),
        borderColor: top.map(([,v])=> v>0?'rgba(74,222,128,1)':'rgba(239,68,68,1)'),
        borderWidth:2
      }]
    },
    options:{
      responsive:true, maintainAspectRatio:false,
      plugins:{ title:{display:true,text:'Draft Performance by Owner',color:'#fff',font:{size:18}} },
      scales:{
        y:{ ticks:{color:'#a0a9c4'}, grid:{color:'#1e2433'}, title:{display:true,text:'Points Above/Below Expected',color:'#a0a9c4'} },
        x:{ ticks:{color:'#a0a9c4'}, grid:{color:'#1e2433'} }
      }
    }
  });
}

function createRecentDraftTable(){
  const ry = getRecentYear(processedData.byYear);
  const recent = ry ? [...(processedData.byYear[ry]||[])] : [];
  recent.sort((a,b)=>{
    const ao = defined(a.overall_pick)?a.overall_pick:(toNum(a.round)*100+toNum(a.pick_number));
    const bo = defined(b.overall_pick)?b.overall_pick:(toNum(b.round)*100+toNum(b.pick_number));
    return ao - bo;
  });

  if (!recent.length){
    setInnerHTML('recentDraftTable', `<tbody><tr><td>${emptyState('No recent draft data.')}</td></tr></tbody>`);
    return;
  }

  const html = `
    <thead>
      <tr><th>Pick</th><th>Round</th><th>Team</th><th>Player</th><th>Position</th><th>Points</th><th>Value</th></tr>
    </thead>
    <tbody>
      ${recent.slice(0,20).map(p=>`
        <tr>
          <td>${defined(p.overall_pick)?p.overall_pick:'-'}</td>
          <td>${defined(p.round)?p.round:'-'}</td>
          <td>${p.team_name || p.owner || 'Unknown'}</td>
          <td><strong>${p.player_name || 'Unknown'}</strong></td>
          <td>${p.position || '-'}</td>
          <td>${toNum(p.actualValue).toFixed(0)}</td>
          <td class="${toNum(p.valueOverExpected)>0?'trend-up':'trend-down'}">
            ${toNum(p.valueOverExpected)>0?'+':''}${toNum(p.valueOverExpected).toFixed(0)}
          </td>
        </tr>`).join('')}
    </tbody>`;
  setInnerHTML('recentDraftTable', html);
  makeSortable('recentDraftTable');
}

/* ===========================
   VALUE
   =========================== */
function loadValueAnalysis(){
  const yearSel = document.getElementById('valueYearSelect');
  const years = Object.keys(processedData.byYear).sort((a,b)=>b-a);
  yearSel.innerHTML = '<option value="all">All Years</option>' + years.map(y=>`<option value="${y}">${y}</option>`).join('');
  yearSel.onchange = updateValueAnalysis;
  document.getElementById('valuePositionSelect').onchange = updateValueAnalysis;
  updateValueAnalysis();
}
function updateValueAnalysis(){
  const y = document.getElementById('valueYearSelect').value;
  const pos = document.getElementById('valuePositionSelect').value;

  let picks = processedData.picks;
  if (y!=='all') picks = picks.filter(p=>p.year===Number(y));
  if (pos!=='all') picks = picks.filter(p=>p.position===pos);

  const sorted = [...picks].sort((a,b)=>toNum(b.valueOverExpected)-toNum(a.valueOverExpected));

  setInnerHTML('bestValues', nonEmpty(sorted) ? sorted.slice(0,10).map((p,i)=>`
    <div class="pick-item">
      <strong>${i+1}.</strong> ${p.player_name || 'Unknown'} <small>(${p.year})</small><br/>
      Round ${defined(p.round)?p.round:'?'} → ${toNum(p.actualValue).toFixed(0)} pts
      <span class="trend-up">(+${toNum(p.valueOverExpected).toFixed(0)} value)</span>
    </div>`).join('') : '<div class="pick-item">No data available</div>');

  setInnerHTML('worstValues', nonEmpty(sorted) ? sorted.slice(-10).reverse().map((p,i)=>`
    <div class="pick-item">
      <strong>${i+1}.</strong> ${p.player_name || 'Unknown'} <small>(${p.year})</small><br/>
      Round ${defined(p.round)?p.round:'?'} → ${toNum(p.actualValue).toFixed(0)} pts
      <span class="trend-down">(${toNum(p.valueOverExpected).toFixed(0)} value)</span>
    </div>`).join('') : '<div class="pick-item">No data available</div>');

  createValueChart(picks);
}
function createValueChart(picks){
  const roundData = {};
  for (let r=1;r<=16;r++) roundData[r]={ expected: expectedFromRound(r), actual:[] };
  picks.forEach(p=>{ if (defined(p.round) && p.round<=16) roundData[p.round].actual.push(toNum(p.actualValue)); });
  const rounds = Object.keys(roundData).map(Number);
  const expected = rounds.map(r=>roundData[r].expected);
  const actual = rounds.map(r=> safeAvg(roundData[r].actual));

  upsertChart('valueChart',{
    type:'line',
    data:{ labels: rounds.map(r=>`Round ${r}`),
      datasets:[
        { label:'Expected Value', data:expected, borderColor:'rgba(251,146,60,.8)', borderDash:[5,5], fill:false },
        { label:'Actual Average Value', data:actual, borderColor:'rgba(74,222,128,.8)', backgroundColor:'rgba(74,222,128,.1)', fill:true }
      ]},
    options:{
      responsive:true, maintainAspectRatio:false,
      plugins:{ title:{display:true,text:'Draft Value by Round',color:'#fff',font:{size:18}}, legend:{labels:{color:'#fff'}} },
      scales:{
        y:{ ticks:{color:'#a0a9c4'}, grid:{color:'#1e2433'}, title:{display:true,text:'Average Points',color:'#a0a9c4'} },
        x:{ ticks:{color:'#a0a9c4'}, grid:{color:'#1e2433'} }
      }
    }
  });
}

/* ===========================
   POSITIONS
   =========================== */
function loadPositionAnalysis(){ createPositionHeatMap(); createPositionTimingChart(); }
function createPositionHeatMap(){
  const positions = ['QB','RB','WR','TE','D/ST','K'];
  const rounds = Array.from({length:10},(_,i)=>i+1);
  const heat = {};
  positions.forEach(pos=>{
    heat[pos]={};
    rounds.forEach(r=>{
      const picks = (processedData.picks||[]).filter(p=>p.position===pos && p.round===r);
      heat[pos][r] = safeAvg(picks.map(p=>p.valueOverExpected));
    });
  });

  if (!positions.length){
    setInnerHTML('positionHeatMap', emptyState('No position data.'));
    return;
  }

  let html = `<div class="heat-map-grid" style="grid-template-columns:auto repeat(${rounds.length},1fr);">`;
  html += `<div class="heat-cell heat-cell-header"></div>`;
  rounds.forEach(r=> html += `<div class="heat-cell heat-cell-header">R${r}</div>`);
  positions.forEach(pos=>{
    html += `<div class="heat-cell heat-cell-header">${pos}</div>`;
    rounds.forEach(r=>{
      const v = heat[pos][r] || 0;
      const abs = Math.min(Math.abs(v)/50,1);
      let bg = 'var(--bg-accent)';
      if (v>0) bg = `rgba(74,222,128,${0.2+abs*0.6})`;
      else if (v<0) bg = `rgba(239,68,68,${0.2+abs*0.6})`;
      html += `<div class="heat-cell" style="background:${bg}">${v!==0?(v>0?'+':'')+v.toFixed(0):'-'}</div>`;
    });
  });
  html += `</div>`;
  setInnerHTML('positionHeatMap', html);
}
function createPositionTimingChart(){
  const years = Object.keys(processedData.byYear).sort();
  const positions = ['QB','RB','WR','TE'];
  const datasets = positions.map((pos,i)=>{
    const data = years.map(y=>{
      const picks = (processedData.byYear[y]||[]).filter(p=>p.position===pos);
      return nonEmpty(picks) ? safeAvg(picks.map(p=>p.round||0)) : null;
    });
    return {
      label: pos,
      data,
      borderColor:`hsl(${i*90},70%,50%)`,
      backgroundColor:`hsla(${i*90},70%,50%,.1)`,
      tension:.3
    };
  });

  upsertChart('positionTimingChart',{
    type:'line',
    data:{ labels:years, datasets },
    options:{
      responsive:true, maintainAspectRatio:false,
      plugins:{ title:{display:true,text:'Average Draft Round by Position Over Time',color:'#fff',font:{size:18}}, legend:{labels:{color:'#fff'}} },
      scales:{
        y:{ reverse:true, ticks:{color:'#a0a9c4'}, grid:{color:'#1e2433'}, title:{display:true,text:'Average Draft Round',color:'#a0a9c4'} },
        x:{ ticks:{color:'#a0a9c4'}, grid:{color:'#1e2433'} }
      }
    }
  });
}

/* ===========================
   ROUNDS
   =========================== */
function loadRoundAnalysis(){ createRoundValueChart(); createRoundTable(); }
function createRoundValueChart(){
  const rounds = Object.keys(processedData.byRound||{}).map(Number).sort((a,b)=>a-b);
  const hitRates = rounds.map(r=>{
    const arr = processedData.byRound[r] || [];
    const hits = arr.filter(p=>toNum(p.valueOverExpected)>10).length;
    return safePct(hits, arr.length);
  });
  const bustRates = rounds.map(r=>{
    const arr = processedData.byRound[r] || [];
    const busts = arr.filter(p=>toNum(p.valueOverExpected)<-20).length;
    return safePct(busts, arr.length);
  });

  upsertChart('roundValueChart',{
    type:'bar',
    data:{ labels: rounds.map(r=>`Round ${r}`),
      datasets:[
        { label:'Hit Rate %', data:hitRates, backgroundColor:'rgba(74,222,128,.6)', borderColor:'rgba(74,222,128,1)', borderWidth:2 },
        { label:'Bust Rate %', data:bustRates, backgroundColor:'rgba(239,68,68,.6)', borderColor:'rgba(239,68,68,1)', borderWidth:2 }
      ]},
    options:{
      responsive:true, maintainAspectRatio:false,
      plugins:{ title:{display:true,text:'Draft Success/Bust Rates by Round',color:'#fff',font:{size:18}}, legend:{labels:{color:'#fff'}} },
      scales:{
        y:{ ticks:{color:'#a0a9c4'}, grid:{color:'#1e2433'}, title:{display:true,text:'Percentage',color:'#a0a9c4'} },
        x:{ ticks:{color:'#a0a9c4'}, grid:{color:'#1e2433'} }
      }
    }
  });
}
function createRoundTable(){
  const rows = Object.entries(processedData.byRound||{}).map(([round, picks])=>{
    const best = (picks||[]).reduce((b,p)=> toNum(p.valueOverExpected) > toNum(b?.valueOverExpected ?? -Infinity) ? p : b, null);
    return {
      round: Number(round),
      total: (picks||[]).length,
      avg: safeAvg((picks||[]).map(p=>p.actualValue)),
      best
    };
  }).sort((a,b)=>a.round-b.round);

  if (!rows.length){
    setInnerHTML('roundTable', `<tbody><tr><td>${emptyState('No round data.')}</td></tr></tbody>`);
    return;
  }

  const html = `
    <thead><tr>
      <th>Round</th><th>Total Picks</th><th>Avg Points</th><th>Best Pick</th><th>Team</th><th>Value</th>
    </tr></thead>
    <tbody>
      ${rows.map(r=>`
        <tr>
          <td><strong>Round ${r.round}</strong></td>
          <td>${r.total}</td>
          <td>${toNum(r.avg).toFixed(1)}</td>
          <td>${r.best?.player_name ?? '—'}</td>
          <td>${r.best?.team_name || r.best?.owner || '—'}</td>
          <td class="trend-up">+${toNum(r.best?.valueOverExpected).toFixed(0)}</td>
        </tr>`).join('')}
    </tbody>`;
  setInnerHTML('roundTable', html);
  makeSortable('roundTable');
}

/* ===========================
   TRENDS
   =========================== */
function loadTrends(){ createTrendsChart(); createYearlyTable(); }
function createTrendsChart(){
  const years = Object.keys(processedData.byYear||{}).sort();
  const avgPoints = years.map(y=> safeAvg((processedData.byYear[y]||[]).map(p=>p.actualValue)));
  const hitRates = years.map(y=>{
    const arr = processedData.byYear[y] || [];
    const hits = arr.filter(p=>toNum(p.valueOverExpected)>0).length;
    return safePct(hits, arr.length);
  });

  upsertChart('trendsChart',{
    type:'line',
    data:{ labels:years,
      datasets:[
        { label:'Avg Points Per Pick', data:avgPoints, borderColor:'rgba(74,158,255,1)', backgroundColor:'rgba(74,158,255,.1)', yAxisID:'y', tension:.3 },
        { label:'Hit Rate %', data:hitRates, borderColor:'rgba(74,222,128,1)', backgroundColor:'rgba(74,222,128,.1)', yAxisID:'y1', tension:.3 }
      ]},
    options:{
      responsive:true, maintainAspectRatio:false,
      plugins:{ title:{display:true,text:'Draft Performance Trends',color:'#fff',font:{size:18}}, legend:{labels:{color:'#fff'}} },
      scales:{
        y:{ type:'linear', position:'left', ticks:{color:'#a0a9c4'}, grid:{color:'#1e2433'}, title:{display:true,text:'Average Points',color:'#a0a9c4'} },
        y1:{ type:'linear', position:'right', ticks:{color:'#a0a9c4'}, grid:{drawOnChartArea:false}, title:{display:true,text:'Hit Rate %',color:'#a0a9c4'} },
        x:{ ticks:{color:'#a0a9c4'}, grid:{color:'#1e2433'} }
      }
    }
  });
}
function createYearlyTable(){
  const rows = Object.entries(processedData.byYear||{}).map(([year, picks])=>{
    const hits = (picks||[]).filter(p=>toNum(p.valueOverExpected)>10).length;
    const busts = (picks||[]).filter(p=>toNum(p.valueOverExpected)<-20).length;
    const best = (picks||[]).reduce((b,p)=> toNum(p.valueOverExpected) > toNum(b?.valueOverExpected ?? -Infinity) ? p : b, null);
    return {
      year: Number(year),
      total: (picks||[]).length,
      avg: safeAvg((picks||[]).map(p=>p.actualValue)),
      hitRate: safePct(hits, (picks||[]).length),
      bustRate: safePct(busts, (picks||[]).length),
      best
    };
  }).sort((a,b)=>b.year-a.year);

  const html = rows.length ? `
    <thead><tr>
      <th>Year</th><th>Picks</th><th>Avg Points</th><th>Hit Rate</th><th>Bust Rate</th><th>Best Pick</th>
    </tr></thead>
    <tbody>
      ${rows.map(r=>`
        <tr>
          <td><strong>${r.year}</strong></td>
          <td>${r.total}</td>
          <td>${toNum(r.avg).toFixed(1)}</td>
          <td class="trend-up">${toNum(r.hitRate).toFixed(1)}%</td>
          <td class="trend-down">${toNum(r.bustRate).toFixed(1)}%</td>
          <td>${r.best?.player_name ?? '—'}</td>
        </tr>`).join('')}
    </tbody>` : `<tbody><tr><td>${emptyState('No yearly data.')}</td></tr></tbody>`;
  setInnerHTML('yearlyTable', html);
  makeSortable('yearlyTable');
}

/* ===========================
   OWNERS
   =========================== */
function loadOwnerAnalysis(){
  const ownerSelect = document.getElementById('ownerSelect');
  const owners = Object.keys(processedData.byOwner||{}).sort();
  ownerSelect.innerHTML = '<option value="">All Owners</option>' + owners.map(o=>`<option value="${o}">${o}</option>`).join('');
  ownerSelect.onchange = updateOwnerAnalysis;
  updateOwnerAnalysis();
}
function updateOwnerAnalysis(){
  const selected = document.getElementById('ownerSelect').value;
  if (selected){
    const picks = processedData.byOwner[selected] || [];
    displayOwnerStats(selected, picks);
    createOwnerChart(selected, picks);
    createOwnerTable(selected, picks);
  } else {
    displayAllOwnersComparison();
  }
}
function displayOwnerStats(owner, picks){
  const avgPoints = safeAvg(picks.map(p=>p.actualValue));
  const avgVOE = safeAvg(picks.map(p=>p.valueOverExpected));
  const hits = picks.filter(p=>toNum(p.valueOverExpected)>10).length;
  const busts = picks.filter(p=>toNum(p.valueOverExpected)<-20).length;

  setInnerHTML('ownerStats', `
    <div class="stat-card"><div class="stat-label">Total Picks</div><div class="stat-value">${picks.length}</div></div>
    <div class="stat-card"><div class="stat-label">Avg Points</div><div class="stat-value">${avgPoints.toFixed(1)}</div>
      <div class="stat-trend">${avgVOE>0?'+':''}${avgVOE.toFixed(1)} vs expected</div></div>
    <div class="stat-card"><div class="stat-label">Hit Rate</div><div class="stat-value trend-up">${safePct(hits,picks.length).toFixed(1)}%</div>
      <div class="stat-trend">${hits} great picks</div></div>
    <div class="stat-card"><div class="stat-label">Bust Rate</div><div class="stat-value trend-down">${safePct(busts,picks.length).toFixed(1)}%</div>
      <div class="stat-trend">${busts} busts</div></div>
  `);
}
function createOwnerChart(owner, picks){
  const years = [...new Set(picks.map(p=>p.year))].sort();
  const avgVOE = years.map(y=>{
    const arr = picks.filter(p=>p.year===y);
    return safeAvg(arr.map(p=>p.valueOverExpected));
  });

  upsertChart('ownerChart',{
    type:'line',
    data:{ labels:years, datasets:[{ label:`${owner} - Value Over Expected`, data:avgVOE, borderColor:'rgba(251,146,60,1)', backgroundColor:'rgba(251,146,60,.1)', tension:.3, fill:true }] },
    options:{
      responsive:true, maintainAspectRatio:false,
      plugins:{ title:{display:true,text:'Draft Performance Over Time',color:'#fff',font:{size:18}}, legend:{labels:{color:'#fff'}} },
      scales:{ y:{ ticks:{color:'#a0a9c4'}, grid:{color:'#1e2433'}, title:{display:true,text:'Avg Value Over Expected',color:'#a0a9c4'} }, x:{ ticks:{color:'#a0a9c4'}, grid:{color:'#1e2433'} } }
    }
  });
}
function createOwnerTable(owner, picks){
  const sorted = [...picks].sort((a,b)=>toNum(b.valueOverExpected)-toNum(a.valueOverExpected));
  const html = nonEmpty(sorted) ? `
    <thead><tr><th>Year</th><th>Round</th><th>Player</th><th>Position</th><th>Points</th><th>Value</th></tr></thead>
    <tbody>
      ${sorted.slice(0,20).map(p=>`
        <tr>
          <td>${p.year}</td>
          <td>${defined(p.round)?p.round:'-'}</td>
          <td><strong>${p.player_name || 'Unknown'}</strong></td>
          <td>${p.position || '-'}</td>
          <td>${toNum(p.actualValue).toFixed(0)}</td>
          <td class="${toNum(p.valueOverExpected)>0?'trend-up':'trend-down'}">${toNum(p.valueOverExpected)>0?'+':''}${toNum(p.valueOverExpected).toFixed(0)}</td>
        </tr>`).join('')}
    </tbody>` : `<tbody><tr><td>${emptyState('No owner data.')}</td></tr></tbody>`;
  setInnerHTML('ownerTable', html);
  makeSortable('ownerTable');
}
function displayAllOwnersComparison(){
  const list = Object.entries(processedData.byOwner||{}).map(([owner, picks])=>{
    const avgVOE = safeAvg(picks.map(p=>p.valueOverExpected));
    const hitRate = safePct(picks.filter(p=>toNum(p.valueOverExpected)>10).length, picks.length);
    const grade = avgVOE>10?'A': avgVOE>0?'B': avgVOE>-10?'C':'D';
    return { owner, picks:picks.length, avgVOE, hitRate, grade };
  }).sort((a,b)=>b.avgVOE-a.avgVOE);

  const top4 = list.slice(0,4);
  setInnerHTML('ownerStats', nonEmpty(top4) ? top4.map(s=>`
    <div class="stat-card">
      <div class="stat-label">${s.owner}</div>
      <div class="stat-value"><span class="grade-badge grade-${s.grade.toLowerCase()}">${s.grade}</span></div>
      <div class="stat-trend">${s.avgVOE>0?'+':''}${s.avgVOE.toFixed(1)} avg value</div>
    </div>`).join('') : emptyState('No owner data.'));

  upsertChart('ownerChart',{
    type:'scatter',
    data:{ datasets:[{
      label:'Owners',
      data: list.map(s=>({ x:toNum(s.hitRate), y:toNum(s.avgVOE), label:s.owner })),
      backgroundColor: list.map(s=>{
        if (s.grade==='A') return 'rgba(74,222,128,.6)';
        if (s.grade==='B') return 'rgba(74,158,255,.6)';
        if (s.grade==='C') return 'rgba(251,191,36,.6)';
        return 'rgba(239,68,68,.6)';
      }),
      pointRadius:8, pointHoverRadius:10
    }]},
    options:{
      responsive:true, maintainAspectRatio:false,
      plugins:{ title:{display:true,text:'Owner Draft Performance',color:'#fff',font:{size:18}}, legend:{display:false},
        tooltip:{ callbacks:{ label:(ctx)=> `${ctx.raw.label}: ${toNum(ctx.raw.x).toFixed(1)}% hit, ${toNum(ctx.raw.y).toFixed(1)} avg value` } } },
      scales:{
        y:{ ticks:{color:'#a0a9c4'}, grid:{color:'#1e2433'}, title:{display:true,text:'Avg Value Over Expected',color:'#a0a9c4'} },
        x:{ ticks:{color:'#a0a9c4'}, grid:{color:'#1e2433'}, title:{display:true,text:'Hit Rate %',color:'#a0a9c4'} }
      }
    }
  });

  const html = nonEmpty(list) ? `
    <thead><tr><th>Owner</th><th>Total Picks</th><th>Avg Value</th><th>Hit Rate</th><th>Grade</th></tr></thead>
    <tbody>
      ${list.map(s=>`
        <tr>
          <td><strong>${s.owner}</strong></td>
          <td>${s.picks}</td>
          <td class="${toNum(s.avgVOE)>0?'trend-up':'trend-down'}">${toNum(s.avgVOE)>0?'+':''}${toNum(s.avgVOE).toFixed(1)}</td>
          <td>${toNum(s.hitRate).toFixed(1)}%</td>
          <td><span class="grade-badge grade-${s.grade.toLowerCase()}">${s.grade}</span></td>
        </tr>`).join('')}
    </tbody>` : `<tbody><tr><td>${emptyState('No owner comparison data.')}</td></tr></tbody>`;
  setInnerHTML('ownerTable', html);
  makeSortable('ownerTable');
}

/* ===========================
   ARCHETYPES (UI)
   =========================== */
function loadArchetypes(){
  const ownerSel = document.getElementById('archOwnerSelect');
  const yearSel = document.getElementById('archYearSelect');

  if (ownerSel.options.length === 1){
    const owners = Object.keys(processedData.byOwner||{}).sort();
    ownerSel.innerHTML = '<option value="">All Owners</option>' + owners.map(o=>`<option value="${o}">${o}</option>`).join('');
  }
  if (yearSel.options.length === 1){
    const years = Object.keys(processedData.byYear||{}).map(Number).sort((a,b)=>b-a);
    yearSel.innerHTML = '<option value="all">All Years</option>' + years.map(y=>`<option value="${y}">${y}</option>`).join('');
  }

  ownerSel.onchange = updateArchetypes;
  yearSel.onchange = updateArchetypes;
  updateArchetypes();
}
function filterCohortsForArchetypes(){
  const owner = document.getElementById('archOwnerSelect').value;
  const yearVal = document.getElementById('archYearSelect').value;
  let cohorts = processedData.archetypes.cohorts || [];
  if (owner) cohorts = cohorts.filter(c=>c.owner===owner);
  if (yearVal!=='all') cohorts = cohorts.filter(c=>c.year===Number(yearVal));
  return cohorts;
}
function updateArchetypes(){
  const cohorts = filterCohortsForArchetypes();
  if (!nonEmpty(cohorts)){
    setInnerHTML('archetypeTopStats', emptyState('No archetype cohorts found.'));
    upsertChart('archetypeBarChart', { type:'bar', data:{labels:[],datasets:[]}, options:{} });
    setInnerHTML('archetypeTable', `<tbody><tr><td>${emptyState('No data')}</td></tr></tbody>`);
    setInnerHTML('firstTwoTable', `<tbody><tr><td>${emptyState('No data')}</td></tr></tbody>`);
    return;
  }

  const avgVOE = safeAvg(cohorts.map(c=>c.avgVOE));
  const archetypeCounts = {};
  cohorts.forEach(c=> archetypeCounts[c.archetype]=(archetypeCounts[c.archetype]||0)+1);
  const topType = Object.entries(archetypeCounts).sort((a,b)=>b[1]-a[1])[0]?.[0] || '—';
  const best = cohorts.reduce((b,c)=> toNum(c.avgVOE) > toNum(b?.avgVOE ?? -Infinity) ? c : b, null);

  setInnerHTML('archetypeTopStats', `
    <div class="stat-card"><div class="stat-label">Owner-Year Cohorts</div><div class="stat-value">${cohorts.length}</div></div>
    <div class="stat-card"><div class="stat-label">Avg Value Over Expected</div><div class="stat-value">${toNum(avgVOE).toFixed(1)}</div></div>
    <div class="stat-card"><div class="stat-label">Most Used Archetype</div><div class="stat-value" style="font-size:1.7rem;">${topType}</div></div>
    <div class="stat-card"><div class="stat-label">Best Cohort</div>
      <div class="stat-value" style="font-size:1.2rem;">${best ? `${best.owner} (${best.year})` : '—'}</div>
      <div class="stat-trend">${best ? (toNum(best.avgVOE)>0?'+':'')+toNum(best.avgVOE).toFixed(1)+' VOE' : ''}</div>
    </div>`);

  createArchetypeBarChart(cohorts);
  createArchetypeTable(cohorts);
  createFirstTwoTable(cohorts);
}
function createArchetypeBarChart(cohorts){
  const byType = {};
  cohorts.forEach(c=> (byType[c.archetype] ||= []).push(c));
  const labels = Object.keys(byType);
  const avgVOE = labels.map(l=> safeAvg(byType[l].map(x=>x.avgVOE)));
  const counts = labels.map(l=> byType[l].length);

  upsertChart('archetypeBarChart',{
    type:'bar',
    data:{ labels,
      datasets:[
        { label:'Avg VOE (All Picks)', data:avgVOE, yAxisID:'y', backgroundColor:'rgba(74,222,128,.6)', borderColor:'rgba(74,222,128,1)', borderWidth:2 },
        { label:'Cohorts', data:counts, yAxisID:'y1', backgroundColor:'rgba(74,158,255,.4)', borderColor:'rgba(74,158,255,1)', borderWidth:2 }
      ]},
    options:{
      responsive:true, maintainAspectRatio:false,
      plugins:{ title:{display:true,text:'Archetype Outcomes',color:'#fff',font:{size:18}} },
      scales:{
        y:{ position:'left', ticks:{color:'#a0a9c4'}, grid:{color:'#1e2433'}, title:{display:true,text:'Avg Value Over Expected',color:'#a0a9c4'} },
        y1:{ position:'right', ticks:{color:'#a0a9c4'}, grid:{drawOnChartArea:false}, title:{display:true,text:'Cohort Count',color:'#a0a9c4'} },
        x:{ ticks:{color:'#a0a9c4'}, grid:{color:'#1e2433'} }
      }
    }
  });
}
function chipFor(pos){
  if (pos==='RB') return '<span class="chip chip-rb">RB</span>';
  if (pos==='WR') return '<span class="chip chip-wr">WR</span>';
  if (pos==='TE') return '<span class="chip chip-te">TE</span>';
  if (pos==='QB') return '<span class="chip chip-qb">QB</span>';
  return '<span class="chip chip-mixed">'+(pos||'—')+'</span>';
}
function createArchetypeTable(cohorts){
  const rows = [...cohorts].sort((a,b)=>toNum(b.avgVOE)-toNum(a.avgVOE));
  const html = `
    <thead><tr>
      <th>Owner</th><th>Year</th><th>Archetype</th><th>R1</th><th>R2</th><th>Avg Points</th><th>Avg VOE</th><th>Hit %</th><th>Bust %</th><th>Best Pick</th>
    </tr></thead>
    <tbody>
      ${rows.map(c=>`
        <tr>
          <td>${c.owner}</td>
          <td>${c.year}</td>
          <td><strong>${c.archetype}</strong></td>
          <td>${chipFor(c.first)}</td>
          <td>${chipFor(c.second)}</td>
          <td>${toNum(c.avgPoints).toFixed(1)}</td>
          <td class="${toNum(c.avgVOE)>0?'trend-up':'trend-down'}">${toNum(c.avgVOE)>0?'+':''}${toNum(c.avgVOE).toFixed(1)}</td>
          <td>${toNum(c.hitRate).toFixed(1)}%</td>
          <td>${toNum(c.bustRate).toFixed(1)}%</td>
          <td>${c.bestPick?.player_name ?? '—'}</td>
        </tr>`).join('')}
    </tbody>`;
  setInnerHTML('archetypeTable', html);
  makeSortable('archetypeTable');
}
function createFirstTwoTable(cohorts){
  const patterns = {};
  cohorts.forEach(c=>{
    const key = `${c.first}-${c.second}`;
    (patterns[key] ||= { key, count:0, avgVOE:0, owners:new Set() });
    patterns[key].count += 1;
    patterns[key].avgVOE += toNum(c.avgVOE);
    patterns[key].owners.add(c.owner);
  });
  const rows = Object.values(patterns).map(p=>({
    pattern: p.key,
    count: p.count,
    owners: p.owners.size,
    avgVOE: p.count ? p.avgVOE / p.count : 0
  })).sort((a,b)=>b.count-a.count);

  const html = rows.length ? `
    <thead><tr><th>R1-R2 Pattern</th><th>Cohorts</th><th>Unique Owners</th><th>Avg VOE</th></tr></thead>
    <tbody>
      ${rows.map(r=>`
        <tr>
          <td>${r.pattern.split('-').map(x=>chipFor(x)).join('')}</td>
          <td>${r.count}</td>
          <td>${r.owners}</td>
          <td class="${toNum(r.avgVOE)>0?'trend-up':'trend-down'}">${toNum(r.avgVOE)>0?'+':''}${toNum(r.avgVOE).toFixed(1)}</td>
        </tr>`).join('')}
    </tbody>` : `<tbody><tr><td>${emptyState('No first-two-pick patterns.')}</td></tr></tbody>`;
  setInnerHTML('firstTwoTable', html);
  makeSortable('firstTwoTable');
}

/* ===========================
   SORTABLE TABLES (robust)
   =========================== */
function makeSortable(tableId){
  const table = document.getElementById(tableId);
  if (!table) return;
  const headers = table.querySelectorAll('th');
  if (!headers.length) return;
  let state = { col:-1, asc:true };
  headers.forEach((th,i)=>{
    th.addEventListener('click',()=>{
      const tbody = table.querySelector('tbody'); if (!tbody) return;
      const rows = Array.from(tbody.querySelectorAll('tr'));
      state.asc = state.col===i ? !state.asc : true; state.col=i;
      headers.forEach(h=>h.classList.remove('sort-asc','sort-desc'));
      th.classList.add(state.asc?'sort-asc':'sort-desc');
      rows.sort((a,b)=>{
        const av = a.cells[i]?.textContent?.trim() ?? '';
        const bv = b.cells[i]?.textContent?.trim() ?? '';
        const an = parseFloat(av.replace(/[^0-9.-]/g,'')); const bn = parseFloat(bv.replace(/[^0-9.-]/g,''));
        if (!Number.isNaN(an) && !Number.isNaN(bn)) return state.asc ? an-bn : bn-an;
        return state.asc ? av.localeCompare(bv) : bv.localeCompare(av);
      });
      rows.forEach(r=>tbody.appendChild(r));
    });
  });
}
</script>
</body>
</html>
